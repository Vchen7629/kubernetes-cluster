- name: Delete PostgreSQL resources
  block:
  - name: Delete PostgreSQL Cluster
    kubernetes.core.k8s:
      api_version: postgresql.cnpg.io/v1
      kind: Cluster
      name: timescaledb-cluster-pg17
      namespace: postgres
      state: absent
      wait: true
      wait_timeout: 300
    ignore_errors: true

  - name: Delete ScheduledBackup
    kubernetes.core.k8s:
      api_version: postgresql.cnpg.io/v1
      kind: ScheduledBackup
      name: timescaledb-weekly-backup
      namespace: postgres
      state: absent
      wait: true
      wait_timeout: 120
    ignore_errors: true

  - name: Wait briefly for cluster pods to terminate
    kubernetes.core.k8s_info:
      kind: Pod
      namespace: postgres
      label_selectors:
        - "cnpg.io/cluster=timescaledb-cluster-pg17"
    register: postgres_pods
    until: postgres_pods.resources | length == 0
    retries: 5
    delay: 5
    ignore_errors: true

  - name: Force delete any stuck cluster pods
    ansible.builtin.shell:
      cmd: kubectl delete pods -n postgres -l cnpg.io/cluster=timescaledb-cluster-pg17 --force --grace-period=0
    ignore_errors: true

  - name: Delete PostgreSQL PVCs
    kubernetes.core.k8s:
      api_version: v1
      kind: PersistentVolumeClaim
      namespace: postgres
      state: absent
      label_selectors:
        - "cnpg.io/cluster=timescaledb-cluster-pg17"
      wait: false
    ignore_errors: true

  - name: Delete ImageCatalog
    kubernetes.core.k8s:
      api_version: postgresql.cnpg.io/v1
      kind: ImageCatalog
      name: cloudnative-pg-timescaledb-pg17
      namespace: postgres
      state: absent
      wait: true
      wait_timeout: 60
    ignore_errors: true

  - name: Delete Postgres Operator Application
    kubernetes.core.k8s:
      api_version: argoproj.io/v1alpha1
      kind: Application
      name: postgres-operator
      namespace: argocd
      state: absent
      wait: false
    ignore_errors: true

  - name: Delete Postgres CRDs Application
    kubernetes.core.k8s:
      api_version: argoproj.io/v1alpha1
      kind: Application
      name: postgres-crds
      namespace: argocd
      state: absent
      wait: false
    ignore_errors: true

  - name: Delete orphaned operator deployment
    kubernetes.core.k8s:
      api_version: apps/v1
      kind: Deployment
      name: postgres-operator-cloudnative-pg
      namespace: postgres
      state: absent
      wait: false
    ignore_errors: true

  - name: Delete orphaned webhook service
    kubernetes.core.k8s:
      api_version: v1
      kind: Service
      name: cnpg-webhook-service
      namespace: postgres
      state: absent
    ignore_errors: true

  - name: Wait briefly for resources to terminate
    ansible.builtin.pause:
      seconds: 10

  - name: Delete CNPG CRDs
    kubernetes.core.k8s:
      api_version: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: "{{ item }}"
      state: absent
      wait: false
    loop:
      - backups.postgresql.cnpg.io
      - clusterimagecatalogs.postgresql.cnpg.io
      #- clusters.postgresql.cnpg.io
      - databases.postgresql.cnpg.io
      - imagecatalogs.postgresql.cnpg.io
      - poolers.postgresql.cnpg.io
      - publications.postgresql.cnpg.io
      - scheduledbackups.postgresql.cnpg.io
      - subscriptions.postgresql.cnpg.io
    ignore_errors: true

  - name: Clear PersistentVolume claimRef
    ansible.builtin.shell:
      cmd: kubectl patch pv hard-drive-pv -p '{"spec":{"claimRef":null}}'
    ignore_errors: true