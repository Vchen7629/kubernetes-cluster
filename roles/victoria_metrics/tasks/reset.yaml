- name: Fully reset Victoria-metrics
  block:
    - name: Delete Victoria Metrics webhooks first
      ansible.builtin.shell: |
        kubectl delete validatingwebhookconfigurations -l app.kubernetes.io/name=victoria-metrics-operator 2>/dev/null || true
        kubectl delete mutatingwebhookconfigurations -l app.kubernetes.io/name=victoria-metrics-operator 2>/dev/null || true
        kubectl get validatingwebhookconfigurations,mutatingwebhookconfigurations -o name 2>/dev/null | grep -E '(vm-|victoria)' | xargs -r kubectl delete 2>/dev/null || true
      ignore_errors: true

    - name: Remove ArgoCD Application finalizers
      ansible.builtin.shell: |
        kubectl patch application vm-stack -n argocd -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
        kubectl patch application vm-crds -n argocd -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
      ignore_errors: true

    - name: Delete ArgoCD Applications
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: "{{ item }}"
        namespace: argocd
        state: absent
      loop:
        - vm-stack
        - vm-crds
      ignore_errors: true

    - name: Nuclear option - Force delete everything
      ansible.builtin.shell: |
        echo "=== NUCLEAR CLEANUP START ==="

        # Step 1: Remove ALL finalizers from ALL Victoria Metrics CRDs
        echo "Step 1: Removing finalizers from VM CRDs..."
        for resource_type in vmagents vmalertmanagers vmsingles vmalerts vmauths vmclusters vmnodescrapes vmpodscrapes vmprobes vmrules vmservicescrapes vmstaticscrapes vmscrapeconfigs vmusers vmalertmanagerconfigs vlogs vlsingles vlclusters vlagents vtsingles vtclusters vmanomalies; do
          kubectl get ${resource_type}.operator.victoriametrics.com -n victoria-metrics -o name 2>/dev/null | xargs -r -I {} kubectl patch {} -n victoria-metrics -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
        done

        # Step 2: Force delete all VM CRDs
        echo "Step 2: Force deleting VM CRDs..."
        kubectl api-resources --api-group=operator.victoriametrics.com --namespaced -o name 2>/dev/null | xargs -r -I {} kubectl delete {} --all -n victoria-metrics --force --grace-period=0 2>/dev/null || true

        # Step 3: Remove finalizers from standard resources
        echo "Step 3: Removing finalizers from standard resources..."
        for resourcetype in statefulsets deployments daemonsets replicasets services secrets serviceaccounts configmaps pvc pods; do
          kubectl get ${resourcetype} -n victoria-metrics -o name 2>/dev/null | xargs -r -I {} kubectl patch {} -n victoria-metrics -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
        done

        # Step 4: Force delete standard resources
        echo "Step 4: Force deleting standard resources..."
        kubectl delete all --all -n victoria-metrics --force --grace-period=0 2>/dev/null || true
        kubectl delete pvc,secret,configmap,serviceaccount --all -n victoria-metrics --force --grace-period=0 2>/dev/null || true

        # Step 5: Remove namespace finalizer
        echo "Step 5: Removing namespace finalizer..."
        kubectl patch namespace victoria-metrics -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true

        echo "=== NUCLEAR CLEANUP COMPLETE ==="
      ignore_errors: true

    - name: Delete victoria-metrics namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: victoria-metrics
        state: absent
        wait: true
        wait_timeout: 300

    - name: Clean up orphaned PersistentVolumes
      ansible.builtin.shell: |
        kubectl get pv -o json | jq -r '.items[] | select(.spec.claimRef.namespace=="victoria-metrics") | .metadata.name' 2>/dev/null | while read pv; do
          kubectl delete pv ${pv} --force --grace-period=0 || true
        done
      ignore_errors: true